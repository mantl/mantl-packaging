#!/usr/bin/env bash
set -e

TMP=/tmp/traefik.toml
REAL=/etc/traefik/traefik.toml

cat > $TMP <<EOF
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
# This file generated by traefik-regen. any edits will be overridden on next
# run.
#
# Put edits in /etc/traefik/configs or run \`traefik-{section}\` where {section}
# is the section you want to edit.
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

# /etc/traefik/global.toml
$(cat /etc/traefik/global.toml)

# /etc/traefik/configs/*.toml
$(cat /etc/traefik/configs/*.toml 2>/dev/null)
EOF

if [[ "$(cat $TMP 2>/dev/null)" != "$(cat $REAL 2>/dev/null)" ]]; then
    mv $TMP $REAL
    sudo /usr/bin/systemctl restart traefik.service
else
    rm $TMP
fi
